{% extends 'base.html.twig' %}

{% block title %}{{ isEdit ? 'Modifier' : 'Ajouter' }} un produit{% endblock %}

{% block body %}
    <h1>{{ isEdit ? 'Modifier' : 'Ajouter' }} un produit</h1>

    {{ form_start(form, {'attr': {'enctype': 'multipart/form-data'}}) }}

    {{ form_row(form.name, { 'label': 'Nom du produit' }) }}
    {{ form_row(form.description, { 'label': 'Description' }) }}
    {{ form_row(form.price, { 'label': 'Prix' }) }}
    {{ form_row(form.stockQuantity, { 'label': 'Quantité en stock' }) }}

    <div class="form-group">
        <label>Images du produit</label>
        <div id="product-images-wrapper" data-prototype="{{ form_widget(form.productImages.vars.prototype)|e('html_attr') }}">
            {% for imageForm in form.productImages %}
    <div class="product-image-item" style="margin-bottom: 10px;">
        {{ form_widget(imageForm.imageFile.children.file) }}

        {% if imageForm.vars.data and imageForm.vars.data.imagesPath %}
            <img src="{{ vich_uploader_asset(imageForm.vars.data, 'imageFile') }}" alt="Image actuelle" class="mb-2" style="max-width: 100px;">
            {{ form_widget(imageForm.imageFile.children.delete) }}
        {% endif %}
    </div>
{% endfor %}

        </div>
    </div>

    <button type="button" id="add-image-button" class="btn btn-primary" style="margin-bottom: 10px;">Ajouter une image</button>
    <button type="submit" class="btn btn-success">Enregistrer</button>

    {{ form_end(form) }}
{% endblock %}

{% block javascript %}
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        let productImagesWrapper = document.getElementById('product-images-wrapper');
        let prototype = productImagesWrapper.dataset.prototype;
        let index = productImagesWrapper.querySelectorAll('.product-image-item').length;

        // Ajouter une nouvelle image
        document.getElementById('add-image-button').addEventListener('click', function () {
            let newForm = prototype.replace(/__name__/g, index);
            let newImageItem = document.createElement('div');
            newImageItem.classList.add('product-image-item');
            newImageItem.innerHTML = newForm;
            productImagesWrapper.appendChild(newImageItem);
            index++;
        });

        // Supprimer une image ajoutée
        productImagesWrapper.addEventListener('click', function (event) {
            if (event.target.classList.contains('remove-image-button')) {
                event.target.closest('.product-image-item').remove();
            }
        });
    });
    </script>
{% endblock %}
