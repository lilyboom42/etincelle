{% extends 'base.html.twig' %}

{% block title %}{{ isEdit ? 'Modifier' : 'Ajouter' }} un produit{% endblock %}

{% block body %}
    <h1>{{ isEdit ? 'Modifier' : 'Ajouter' }} un produit</h1>

    {{ form_start(form, {'attr': {'enctype': 'multipart/form-data'}}) }}

    {{ form_row(form.name, { 'label': 'Nom du produit' }) }}
    {{ form_row(form.description, { 'label': 'Description' }) }}
    {{ form_row(form.price, { 'label': 'Prix' }) }}
    {{ form_row(form.stockQuantity, { 'label': 'Quantité en stock' }) }}

    <div class="form-group">
        <label>Images du produit</label>
        <div id="product-images-wrapper" data-prototype="{{ form_widget(form.productImages.vars.prototype)|e('html_attr') }}">
            {% for imageForm in form.productImages %}
                <div class="product-image-item" style="margin-bottom: 10px;">
                    {{ form_widget(imageForm.imageFile) }}

                    {% if imageForm.vars.data and imageForm.vars.data.imagesPath %}
                        <img src="{{ asset(imageForm.vars.data.imagesPath) }}" alt="Image actuelle" class="mb-2" style="max-width: 100px;">
                        <input type="hidden" name="remove-image-{{ loop.index }}" value="0" class="remove-image-input">
                        <button type="button" class="btn btn-danger remove-existing-image" data-image-id="{{ loop.index }}">Supprimer l'image</button>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    </div>

    <button type="button" id="add-image-button" class="btn btn-primary" style="margin-bottom: 10px;">Ajouter une image</button>
    <button type="submit" class="btn btn-success">Enregistrer</button>

    {{ form_end(form) }}
{% endblock %}

{% block javascript %}
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        let productImagesWrapper = document.getElementById('product-images-wrapper');
        let prototype = productImagesWrapper.dataset.prototype;
        let index = productImagesWrapper.querySelectorAll('.product-image-item').length;

        // Ajouter une nouvelle image
        document.getElementById('add-image-button').addEventListener('click', function () {
            let newForm = prototype.replace(/__name__/g, index);
            let newImageItem = document.createElement('div');
            newImageItem.classList.add('product-image-item');
            newImageItem.innerHTML = newForm + '<button type="button" class="btn btn-danger remove-image-button">Supprimer</button>';
            productImagesWrapper.appendChild(newImageItem);
            index++;
        });

        // Supprimer une image ajoutée
        productImagesWrapper.addEventListener('click', function (event) {
            if (event.target.classList.contains('remove-image-button')) {
                event.target.closest('.product-image-item').remove();
            }
        });

        // Supprimer une image existante
        productImagesWrapper.addEventListener('click', function (event) {
            if (event.target.classList.contains('remove-existing-image')) {
                let imageId = event.target.getAttribute('data-image-id');
                let removeInput = document.querySelector('input[name="remove-image-' + imageId + '"]');
                if (removeInput) {
                    removeInput.value = 1; // Marquer l'image pour suppression
                }
                event.target.closest('.product-image-item').remove();
            }
        });
    });
    </script>
{% endblock %}
