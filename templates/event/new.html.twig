{# templates/event/form.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}
    {{ isEdit ? 'Modifier' : 'Ajouter' }} un événement
{% endblock %}

{% block body %}
    <main class="event-form-main">
        <h1 class="event-form-title">{{ isEdit ? 'Modifier' : 'Ajouter' }} un événement</h1>

        <form class="event-form-container" method="post" enctype="multipart/form-data">
            {{ form_start(form, {'attr': {'class': 'form-container'}}) }}
                {{ form_errors(form) }}

                <div class="form-group">
                    {{ form_label(form.title) }}
                    {{ form_widget(form.title, {'attr': {'class': 'form-control'}}) }}
                    {{ form_errors(form.title) }}
                </div>

                <div class="form-group">
                    {{ form_label(form.description) }}
                    {{ form_widget(form.description, {'attr': {'class': 'form-control'}}) }}
                    {{ form_errors(form.description) }}
                </div>

                <div class="form-group">
                    {{ form_label(form.eventDate) }}
                    {{ form_widget(form.eventDate, {'attr': {'class': 'form-control'}}) }}
                    {{ form_errors(form.eventDate) }}
                </div>

                <div id="event-media-wrapper" class="media-wrapper" data-prototype="{{ form_widget(form.media.vars.prototype)|e('html_attr') }}">
                    {% if isEdit and event.media|length > 0 %}
                        <h3 class="media-existing-title">Médias existants :</h3>
                        <div class="existing-media-list">
                            {% for media in event.media %}
                                <div class="event-media-item mb-2">
                                    <p>Média actuel : <a href="{{ vich_uploader_asset(media, 'mediaFile') }}" target="_blank" class="media-link">{{ media.filename }}</a></p>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}

                    {% for mediaForm in form.media %}
                        <div class="form-group media-form-group">
                            {{ form_label(mediaForm) }}
                            {{ form_widget(mediaForm, {'attr': {'class': 'form-control media-input'}}) }}
                            {{ form_errors(mediaForm) }}
                        </div>
                    {% endfor %}
                </div>

                <button type="submit" class="btn btn-success mt-3">
                    {{ isEdit ? 'Enregistrer les modifications' : 'Créer l\'événement' }}
                </button>
            {{ form_end(form) }}
        </form>
    </main>
{% endblock %}

{% block javascript %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var $collectionHolder = document.querySelector('#event-media-wrapper');

            var addMediaButton = document.createElement('button');
            addMediaButton.type = 'button';
            addMediaButton.className = 'btn btn-primary mb-3 add-media-button';
            addMediaButton.innerText = 'Ajouter un média';

            var newLinkDiv = document.createElement('div');
            newLinkDiv.appendChild(addMediaButton);

            $collectionHolder.appendChild(newLinkDiv);

            $collectionHolder.dataset.index = $collectionHolder.querySelectorAll('.event-media-item').length;

            addMediaButton.addEventListener('click', function(e) {
                addMediaForm($collectionHolder, newLinkDiv);
            });
        });

        function addMediaForm($collectionHolder, newLinkDiv) {
            var prototype = $collectionHolder.dataset.prototype;
            var index = $collectionHolder.dataset.index;

            var newForm = prototype.replace(/__name__/g, index);
            $collectionHolder.dataset.index = parseInt(index) + 1;

            var newFormDiv = document.createElement('div');
            newFormDiv.innerHTML = newForm;
            newFormDiv.classList.add('event-media-item', 'mb-2', 'media-form-item');

            var removeButton = document.createElement('button');
            removeButton.type = 'button';
            removeButton.className = 'btn btn-danger remove-media-button mt-2';
            removeButton.innerText = 'Supprimer';

            newFormDiv.appendChild(removeButton);

            $collectionHolder.insertBefore(newFormDiv, newLinkDiv);

            removeButton.addEventListener('click', function(e) {
                e.preventDefault();
                $collectionHolder.removeChild(newFormDiv);
            });
        }
    </script>
{% endblock %}
