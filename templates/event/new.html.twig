{% extends 'base.html.twig' %}

{% block title %}
    {{ isEdit ? 'Modifier' : 'Ajouter' }} un événement
{% endblock %}

{% block body %}
    <h1>{{ isEdit ? 'Modifier' : 'Ajouter' }} un événement</h1>

    {{ form_start(form, {'attr': {'enctype': 'multipart/form-data'}}) }}
        {{ form_errors(form) }}

        {{ form_row(form.title) }}
        {{ form_row(form.description) }}
        {{ form_row(form.eventDate) }}

        <div id="event-media-wrapper" data-prototype="{{ form_widget(form.media.vars.prototype)|e('html_attr') }}">
            {% if isEdit and event.media|length > 0 %}
                <h3>Médias existants :</h3>
                {% for media in event.media %}
                    <div class="event-media-item mb-2">
                        <p>Média actuel : <a href="{{ vich_uploader_asset(media, 'mediaFile') }}" target="_blank">{{ media.filename }}</a></p>
                    </div>
                {% endfor %}
            {% endif %}

            {% for mediaForm in form.media %}
                {{ form_row(mediaForm) }}
            {% endfor %}
        </div>

        <button type="submit" class="btn btn-success">
            {{ isEdit ? 'Enregistrer les modifications' : 'Créer l\'événement' }}
        </button>

    {{ form_end(form) }}
{% endblock %}

{% block javascript %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var $collectionHolder = document.querySelector('#event-media-wrapper');

            var addMediaButton = document.createElement('button');
            addMediaButton.type = 'button';
            addMediaButton.className = 'btn btn-primary mb-3';
            addMediaButton.innerText = 'Ajouter un média';

            var newLinkDiv = document.createElement('div');
            newLinkDiv.appendChild(addMediaButton);

            $collectionHolder.appendChild(newLinkDiv);

            $collectionHolder.dataset.index = $collectionHolder.querySelectorAll('.event-media-item').length;

            addMediaButton.addEventListener('click', function(e) {
                addMediaForm($collectionHolder, newLinkDiv);
            });
        });

        function addMediaForm($collectionHolder, newLinkDiv) {
            var prototype = $collectionHolder.dataset.prototype;
            var index = $collectionHolder.dataset.index;

            var newForm = prototype.replace(/__name__/g, index);
            $collectionHolder.dataset.index = parseInt(index) + 1;

            var newFormDiv = document.createElement('div');
            newFormDiv.innerHTML = newForm;
            newFormDiv.classList.add('event-media-item', 'mb-2');

            var removeButton = document.createElement('button');
            removeButton.type = 'button';
            removeButton.className = 'btn btn-danger remove-media-button mt-2';
            removeButton.innerText = 'Supprimer';

            newFormDiv.appendChild(removeButton);

            $collectionHolder.insertBefore(newFormDiv, newLinkDiv);

            removeButton.addEventListener('click', function(e) {
                e.preventDefault();
                $collectionHolder.removeChild(newFormDiv);
            });
        }
    </script>
{% endblock %}
